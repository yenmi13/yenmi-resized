<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>16-Bit Image Resizer PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="unnamed.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'VT323', monospace;
            background-color: #000;
            color: #00FF00; /* Classic green terminal color */
            text-shadow: 0 0 2px #00FF00;
        }
        .container-box {
            border: 2px solid #00FF00;
            padding: 20px;
            box-shadow: 0 0 10px #00FF00;
        }
        .title-bar {
            background-color: #00FF00;
            color: #000;
            padding: 5px 10px;
            font-size: 1.25rem;
            text-shadow: none;
        }
        .content-area {
            padding-top: 20px;
        }
        input[type="number"], input[type="file"], select {
            background-color: #111;
            border: 1px solid #00FF00;
            color: #00FF00;
            padding: 8px;
            outline: none;
            width: 100%;
        }
        input[type="number"]:focus, select:focus {
            box-shadow: 0 0 5px #00FF00;
        }
        .btn, .preset-btn, .file-label {
            background-color: transparent;
            border: 2px solid #00FF00;
            color: #00FF00;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .btn:hover, .preset-btn:hover, .file-label:hover {
            background-color: #00FF00;
            color: #000;
            text-shadow: none;
        }
        .btn:disabled {
            color: #555;
            border-color: #555;
            cursor: not-allowed;
            background-color: transparent;
        }
        .preset-btn.active {
            background-color: #00FF00;
            color: #000;
            text-shadow: none;
        }
        .preview-box {
            border: 2px dashed #00FF00;
            width: 100%;
            padding-top: 100%; /* 1:1 aspect ratio */
            position: relative;
            background-color: #0a0a0a;
        }
        .preview-box img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .preview-box .placeholder {
             position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #008f00;
            font-size: 1.5rem;
        }
        .blinking-cursor {
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
        /* Hide number input arrows */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto container-box">
        <div class="title-bar">
            <p>C:\> RESIZE_PRO.EXE</p>
        </div>
        <div class="content-area">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-lg">

                <!-- Controls -->
                <div class="space-y-6">
                    <!-- Step 1: Upload -->
                    <div>
                        <p class="mb-2">> STEP 1: LOAD IMAGE</p>
                        <label for="image-upload" class="file-label block">UPLOAD_FILE.BAT</label>
                        <input type="file" id="image-upload" class="hidden" accept="image/*">
                        <p id="file-name" class="mt-2 h-6 text-green-300"></p>
                    </div>

                    <!-- Step 2: Presets -->
                    <div>
                        <p class="mb-2">> STEP 2: SELECT PRESET</p>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="preset-btn" data-w="1200" data-h="630">FB POST</button>
                            <button class="preset-btn" data-w="1080" data-h="1080">IG POST</button>
                            <button class="preset-btn" data-w="1080" data-h="1920">IG STORY</button>
                            <button class="preset-btn active" id="custom-btn">CUSTOM</button>
                        </div>
                    </div>

                    <!-- Step 3: Custom Size -->
                    <div>
                        <p class="mb-2">> STEP 3: DEFINE DIMENSIONS (PX)</p>
                        <div class="flex items-center gap-4">
                            <input type="number" id="width-input" placeholder="WIDTH">
                            <span>x</span>
                            <input type="number" id="height-input" placeholder="HEIGHT">
                        </div>
                    </div>

                    <!-- Step 4: Output Settings -->
                    <div>
                        <p class="mb-2">> STEP 4: OUTPUT SETTINGS</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="format-select">FORMAT:</label>
                                <select id="format-select">
                                    <option value="jpeg">JPEG</option>
                                    <option value="png">PNG</option>
                                </select>
                            </div>
                            <div id="target-size-container">
                                <label for="target-size-input">TARGET SIZE (KB):</label>
                                <input type="number" id="target-size-input" placeholder="e.g. 500">
                            </div>
                        </div>
                    </div>
                    
                    <button id="resize-btn" class="btn w-full text-2xl" disabled>
                        [ GENERATE ]
                    </button>
                </div>

                <!-- Preview & Download -->
                <div class="space-y-4 flex flex-col items-center">
                    <p class="text-center">> OUTPUT_PREVIEW.LOG</p>
                    <div class="w-full max-w-md">
                        <div id="preview-box" class="preview-box">
                            <div class="placeholder">Awaiting Input...</div>
                        </div>
                    </div>
                    <div id="result-info" class="text-center h-6"></div>
                    <a id="download-link" class="btn w-full max-w-md hidden">DOWNLOAD</a>
                </div>

            </div>
        </div>
        <p class="mt-4 text-center text-sm">> STATUS: READY<span class="blinking-cursor">_</span></p>
    </div>

    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const imageUpload = document.getElementById('image-upload');
        const widthInput = document.getElementById('width-input');
        const heightInput = document.getElementById('height-input');
        const resizeBtn = document.getElementById('resize-btn');
        const downloadLink = document.getElementById('download-link');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const fileNameSpan = document.getElementById('file-name');
        const previewBox = document.getElementById('preview-box');
        const resultInfo = document.getElementById('result-info');
        const presetBtns = document.querySelectorAll('.preset-btn');
        const customBtn = document.getElementById('custom-btn');
        const formatSelect = document.getElementById('format-select');
        const targetSizeInput = document.getElementById('target-size-input');
        const targetSizeContainer = document.getElementById('target-size-container');

        let originalImage = null;
        let originalFileName = '';

        // --- Event Listeners ---

        imageUpload.addEventListener('change', handleImageUpload);
        resizeBtn.addEventListener('click', processImage);
        
        presetBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                presetBtns.forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                if (e.target.id !== 'custom-btn') {
                    widthInput.value = e.target.dataset.w;
                    heightInput.value = e.target.dataset.h;
                }
            });
        });

        formatSelect.addEventListener('change', () => {
            targetSizeContainer.style.display = formatSelect.value === 'jpeg' ? 'block' : 'none';
        });

        // --- Core Functions ---

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file || !file.type.startsWith('image/')) {
                fileNameSpan.textContent = 'ERROR: INVALID FILE TYPE';
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    resizeBtn.disabled = false;
                    fileNameSpan.textContent = `LOADED: ${file.name}`;
                    originalFileName = file.name.split('.').slice(0, -1).join('.');
                    previewBox.innerHTML = `<img src="${event.target.result}" alt="Preview">`;
                    downloadLink.classList.add('hidden');
                    resultInfo.textContent = '';
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function processImage() {
            if (!originalImage) {
                resultInfo.textContent = 'ERROR: NO IMAGE LOADED';
                return;
            }

            const targetWidth = parseInt(widthInput.value, 10);
            const targetHeight = parseInt(heightInput.value, 10);
            const format = formatSelect.value;
            const targetSizeKB = parseInt(targetSizeInput.value, 10);

            if (isNaN(targetWidth) || isNaN(targetHeight) || targetWidth <= 0 || targetHeight <= 0) {
                resultInfo.textContent = 'ERROR: INVALID DIMENSIONS';
                return;
            }

            resizeBtn.disabled = true;
            resizeBtn.textContent = '[ PROCESSING... ]';
            resultInfo.textContent = 'Executing...';

            // Draw image to canvas with "cover" logic
            drawToCanvas(targetWidth, targetHeight);

            let outputBlob;
            const mimeType = `image/${format}`;

            if (format === 'jpeg' && !isNaN(targetSizeKB) && targetSizeKB > 0) {
                // Attempt to get blob with target size
                outputBlob = await getJpegBlobWithTargetSize(canvas, targetSizeKB * 1024);
            } else {
                // Standard conversion
                outputBlob = await new Promise(resolve => canvas.toBlob(resolve, mimeType, format === 'jpeg' ? 0.95 : undefined));
            }

            const objectURL = URL.createObjectURL(outputBlob);
            const finalSizeKB = (outputBlob.size / 1024).toFixed(2);

            previewBox.innerHTML = `<img src="${objectURL}" alt="Resized Image">`;
            downloadLink.href = objectURL;
            downloadLink.download = `${originalFileName}_${targetWidth}x${targetHeight}.${format}`;
            downloadLink.classList.remove('hidden');
            resultInfo.textContent = `SUCCESS: ${finalSizeKB} KB`;
            resizeBtn.disabled = false;
            resizeBtn.textContent = '[ GENERATE ]';
        }

        function drawToCanvas(targetWidth, targetHeight) {
            canvas.width = targetWidth;
            canvas.height = targetHeight;

            const srcRatio = originalImage.width / originalImage.height;
            const targetRatio = targetWidth / targetHeight;
            let drawWidth, drawHeight, offsetX, offsetY;

            if (srcRatio > targetRatio) {
                drawHeight = originalImage.height;
                drawWidth = drawHeight * targetRatio;
                offsetX = (originalImage.width - drawWidth) / 2;
                offsetY = 0;
            } else {
                drawWidth = originalImage.width;
                drawHeight = drawWidth / targetRatio;
                offsetX = 0;
                offsetY = (originalImage.height - drawHeight) / 2;
            }

            ctx.drawImage(originalImage, offsetX, offsetY, drawWidth, drawHeight, 0, 0, targetWidth, targetHeight);
        }

        /**
         * Uses a binary search approach to find the JPEG quality that results
         * in a file size closest to the target size.
         * @param {HTMLCanvasElement} canvasEl - The canvas with the image data.
         * @param {number} targetSizeBytes - The target file size in bytes.
         * @returns {Promise<Blob>} A promise that resolves with the final Blob.
         */
        async function getJpegBlobWithTargetSize(canvasEl, targetSizeBytes) {
            let minQuality = 0;
            let maxQuality = 1;
            let bestBlob = null;

            // Iterate a few times to find the best quality
            for (let i = 0; i < 7; i++) {
                const quality = (minQuality + maxQuality) / 2;
                const blob = await new Promise(resolve => canvasEl.toBlob(resolve, 'image/jpeg', quality));
                
                if (!bestBlob || Math.abs(blob.size - targetSizeBytes) < Math.abs(bestBlob.size - targetSizeBytes)) {
                    bestBlob = blob;
                }

                if (blob.size > targetSizeBytes) {
                    maxQuality = quality;
                } else {
                    minQuality = quality;
                }
            }
            return bestBlob;
        }
    </script>
</body>
</html>
